<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تقرير ساعات التدريس الديناميكي (XLSX)</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Optional: Add Arial Black if it's a common web font or fallback for it -->
    <link href="https://fonts.googleapis.com/css2?family=Arial+Black&display=swap" rel="stylesheet">
    <!-- SheetJS CDN for XLSX file parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- html2pdf.js CDN for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff; /* Changed to white */
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            min-height: 100vh; /* Ensure body takes full viewport height */
        }
        .section-card {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 2rem;
            max-width: 800px;
            width: 100%;
            text-align: center;
        }
        .report-display-area {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .report-container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            max-width: 800px;
            width: 100%;
            margin-bottom: 1rem; /* Reduced space */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem; /* Reduced space */
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem; /* Reduced padding */
            text-align: center;
        }
        th {
            background-color: #f2f2f2; /* Changed to a slightly darker light gray */
            font-weight: 600;
            color: #374151;
        }
        .text-center-aligned {
            text-align: center;
        }
        .text-right-aligned {
            text-align: right;
        }
        /* New styles for signature section */
        .signature-section-new {
            display: flex;
            justify-content: space-around;
            margin-top: 3rem;
            text-align: center;
            flex-wrap: wrap;
            width: 100%; /* Ensure it spans full width for better distribution */
        }
        .signature-block {
            flex: 1;
            min-width: 200px; /* Minimum width for each signature box */
            margin: 0 0.5rem; /* Margin between boxes */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end; /* Align content to the bottom */
            position: relative;
            padding-bottom: 0.5rem; /* Space for the name below the line */
        }
        .signature-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 0.5rem; /* Space between title and line */
            color: #374151; /* Dark gray for text */
        }
        .signature-line {
            width: 90%; /* Line for signature */
            border-bottom: 1px solid #d1d5db;
            margin-bottom: 0.5rem; /* Space between line and name */
        }
        .signature-name-actual, .signature-name-placeholder {
            font-size: 1rem;
            color: #4b5563; /* Slightly lighter gray for names */
            font-weight: 500;
        }
        .signature-name-actual {
            font-weight: bold; /* Bold the actual name */
            font-family: 'Arial Black', Gadget, sans-serif;
            margin-top: -0.3em; /* Adjust to pull up slightly */
        }

        /* Loading indicator styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none; /* Hidden by default */
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Styles specific to the header with logos for print */
        .print-header-with-logos {
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: center;
            position: relative; /* Needed for absolute positioning of images */
            padding: 0 170px; /* Adjusted padding to accommodate larger logos */
        }
        .print-header-with-logos img {
            position: absolute;
            width: 160px; /* Enlarged size */
            height: 160px; /* Enlarged size */
            object-fit: contain;
            top: 50%;
            transform: translateY(-50%);
        }
        .print-header-with-logos .logo-left {
            left: 0;
        }
        .print-header-with-logos .logo-right {
            right: 0;
        }
        /* Header specific styling */
        .app-header {
            background-color: #2196f3; /* Bright blue as requested */
            color: white;
            padding: 1rem;
            width: 100%;
            text-align: center;
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 2rem;
            border-radius: 0.75rem; /* Rounded corners */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Button styling */
        .bg-green-500 {
            background-color: #4CAF50; /* Green for accept/execute */
        }
        .hover\:bg-green-700:hover {
            background-color: #45a049;
        }
        .bg-red-500 {
            background-color: #f44336; /* Red for cancel/delete/stop (not used in this specific button, but good to define) */
        }
        .hover\:bg-red-700:hover {
            background-color: #da190b;
        }
        .bg-indigo-500 { /* For print current report button */
            background-color: #3f51b5;
        }
        .hover\:bg-indigo-700:hover {
            background-color: #303f9f;
        }

        /* --- Print Specific Styles --- */
        @media print {
            body {
                margin: 0;
                padding: 0;
                background-color: #ffffff; 
                color: #000000; /* Ensure all body text is black in print */
            }
            .app-header, .upload-section, .staff-selection-section {
                display: none !important; 
            }
            .report-display-area {
                margin: 0;
                padding: 0;
                width: auto; 
                align-items: flex-start; 
            }
            .report-content-to-print {
                width: 190mm; /* Fixed width for A4 portrait content area */
                max-width: 190mm; /* Ensure it doesn't exceed this */
                margin: 0 auto; /* Center content on page */
                padding: 3mm; /* Further reduced internal padding for print */
                box-shadow: none;
                border: none;
                background-color: #ffffff;
            }
            .report-content-to-print h1, .report-content-to-print h2, .report-content-to-print h3, .report-content-to-print h4 {
                color: #000000 !important; /* Force all headings to black */
                line-height: 1.1 !important; /* Tighten line height for headings */
                margin-bottom: 0.3rem !important; /* Reduce spacing below headings */
            }
            .report-content-to-print p, .report-content-to-print span {
                color: #000000 !important; /* Force all text to black */
                line-height: 1.1 !important; /* Adjust line height for print */
                margin-bottom: 0.1rem !important; /* Reduce paragraph spacing */
            }
            .print-header-with-logos {
                padding: 0 10mm !important; /* Reduced padding for logos in print */
                margin-bottom: 0.5rem !important; /* Reduced margin below header */
            }
            .print-header-with-logos img {
                width: 100px !important; /* Smaller logo size in print */
                height: 100px !important; /* Smaller logo size in print */
            }
            .report-content-to-print table {
                margin-top: 0.2rem !important; /* Reduced table top margin */
                margin-bottom: 0.2rem !important; /* Reduced table bottom margin */
            }
            .report-content-to-print th, .report-content-to-print td {
                padding: 0.2rem !important; /* Reduced table cell padding */
                font-size: 0.75rem !important; /* Smaller font for table cells */
                line-height: 1.1 !important; /* Tighten line height in tables */
            }
            .report-content-to-print .mb-4 {
                margin-bottom: 0.3rem !important; /* Reduced margin between general sections for print */
            }
            .signature-section-new {
                margin-top: 0.8rem !important; /* Reduced top margin for signature section */
                flex-direction: column; /* Stack signatures vertically for print */
                align-items: flex-start; /* Align all signature blocks to the start */
            }
            .signature-block {
                min-width: auto !important; /* Allow width to be determined by content */
                width: 100% !important; /* Take full width */
                margin: 0 !important; /* Remove horizontal margin */
                padding-bottom: 0.1rem !important; /* Reduced padding below signature line */
                text-align: left !important; /* Align content within block to left */
                align-items: flex-start !important; /* Align content to start within block */
            }
            .signature-title {
                font-size: 0.8em !important; /* Smaller signature title */
            }
            .signature-name-actual, .signature-name-placeholder {
                font-size: 0.7em !important; /* Smaller signature names */
            }
            /* Specific styling for the Dean's signature block */
            .dean-signature {
                margin-top: 1rem !important; /* Add more space above dean's signature */
                padding-top: 0.5rem !important; /* Add padding to push down content */
                font-size: 1.2em !important; /* Larger font for dean's signature */
                font-weight: bold !important; /* Bold for dean's signature */
                text-align: left !important; /* Align to left for dean's signature */
                width: 100% !important; /* Ensure it takes full width */
                align-items: flex-start !important; /* Align content to start within block */
            }
            .dean-signature .signature-title {
                font-size: 1.2em !important; /* Larger title for dean's signature */
                font-weight: bold !important;
            }
            .dean-signature .signature-name-actual {
                font-size: 1.2em !important; /* Larger name for dean's signature */
                font-weight: bold !important;
            }
            .combined-reports-container .report-content-to-print:not(:last-child) {
                page-break-after: always !important; 
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="app-header">
        Developed by Dr. Mazen Badawy – Doctorate of English Teaching & Testing
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="section-card upload-section">
        <h3 class="text-xl font-bold mb-4">تحميل ملف ساعات التدريس (XLSX)</h3>
        <!-- File input, now triggers processing directly on change -->
        <input type="file" id="xlsxFileInput" accept=".xlsx" class="mb-4 p-2 border rounded-md">
        
        <!-- Buttons for printing -->
        <div class="flex flex-col sm:flex-row justify-center mt-4 space-y-4 sm:space-y-0 sm:space-x-4 w-full">
            <button id="printAllReportsButton" class="bg-green-500 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out w-full sm:w-auto text-lg">
                طباعة جميع التقارير PDF
            </button>
            <button id="printCurrentReportButton" class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out w-full sm:w-auto text-lg">
                طباعة التقرير الحالي PDF
            </button>
        </div>
        
        <p id="messageBox" class="text-red-500 mt-2"></p>
    </div>

    <div class="section-card staff-selection-section" style="display: none;">
        <h3 class="text-xl font-bold mb-4">اختيار عضو هيئة التدريس</h3>
        <select id="staffSelect" class="p-2 border rounded-md w-full md:w-1/2">
            <option value="">-- الرجاء الاختيار --</option>
        </select>
    </div>

    <div id="reportDisplayArea" class="report-display-area mt-4">
        <p class="text-gray-600">اختر عضواً من القائمة المنسدلة لعرض تقريره.</p>
    </div>

    <script>
        // Ensure the DOM is fully loaded before running the script
        document.addEventListener('DOMContentLoaded', function() {
            let allRecords = []; // Stores parsed XLSX data (excluding headers, starting from Excel row 3)
            let headers = [];    // Stores XLSX headers (from Excel row 2)

            const xlsxFileInput = document.getElementById('xlsxFileInput');
            const staffSelect = document.getElementById('staffSelect');
            const reportDisplayArea = document.getElementById('reportDisplayArea');
            const messageBox = document.getElementById('messageBox');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const staffSelectionSection = document.querySelector('.staff-selection-section');
            const printAllReportsButton = document.getElementById('printAllReportsButton');
            const printCurrentReportButton = document.getElementById('printCurrentReportButton'); // New button

            // Event listeners
            xlsxFileInput.addEventListener('change', processFile); // Auto-process on file selection
            staffSelect.addEventListener('change', displaySelectedStaffReport);
            printAllReportsButton.addEventListener('click', generateAllReportsAndPrint);
            printCurrentReportButton.addEventListener('click', printCurrentReport); // New event listener

            // Define orderedArabicDays and dayMap here so they are accessible to all functions
            const orderedArabicDays = ["السبت", "الأحد", "الاثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة"]; 
            const dayMap = {
                'السبت': 'السبت',
                'الاحد': 'الأحد', 
                'الأحد': 'الأحد',
                'الاثنين': 'الاثنين',
                'الإثنين': 'الاثنين', 
                'الثلاثاء': 'الثلاثاء',
                'الار اربعاء': 'الأربعاء', // Corrected a typo here based on common user input
                'الاربعاء': 'الأربعاء', // Ensure both forms map to the same
                'الأربعاء': 'الأربعاء',
                'الخميس': 'الخميس',
                'الجمعة': 'الجمعة',
                'اليوم الاول': 'السبت',
                'اليوم الثاني': 'الأحد',
                'اليوم الثالث': 'الاثنين',
                'اليوم الرابع': 'الثلاثاء', 
                'اليوم الخامس': 'الأربعاء'  
            };

            async function processFile() {
                const file = xlsxFileInput.files[0];

                if (!file) {
                    messageBox.textContent = 'الرجاء اختيار ملف XLSX.';
                    return;
                }

                // Clear previous data and messages
                allRecords = [];
                headers = [];
                staffSelect.innerHTML = '<option value="">-- الرجاء الاختيار --</option>';
                reportDisplayArea.innerHTML = '<p class="text-gray-600">اختر عضواً من القائمة المنسدلة لعرض تقريره.</p>';
                messageBox.textContent = '';
                staffSelectionSection.style.display = 'none';
                loadingOverlay.style.display = 'flex'; // Show loading indicator

                try {
                    // Added a check and a small delay to ensure XLSX library is loaded
                    if (typeof XLSX === 'undefined' || !XLSX.read) {
                        messageBox.textContent = 'جارٍ تحميل مكتبة معالجة الملفات... الرجاء الانتظار قليلاً وإعادة المحاولة.';
                        await new Promise(resolve => setTimeout(resolve, 500)); // Wait 0.5 seconds
                        if (typeof XLSX === 'undefined' || !XLSX.read) {
                            throw new Error('لم يتم تحميل مكتبة XLSX. يرجى التحقق من اتصالك بالإنترنت أو إعادة تحميل الصفحة.');
                        }
                    }

                    const data = await readFileAsArrayBuffer(file);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    const rawSheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: true });

                    if (rawSheetData.length < 3) {
                        messageBox.textContent = 'الملف فارغ أو لا يحتوي على بيانات كافية (يتوقع رؤوس في الصف الثاني وبيانات في الصف الثالث).';
                        loadingOverlay.style.display = 'none';
                        return;
                    }

                    headers = rawSheetData[1];
                    allRecords = rawSheetData.slice(2);
                    allRecords = allRecords.filter(row => row && row.some(cell => String(cell).trim() !== ''));

                    if (allRecords.length === 0) {
                        messageBox.textContent = 'لم يتم العثور على سجلات بيانات صالحة بعد رؤوس الأعمدة.';
                        loadingOverlay.style.display = 'none';
                        return;
                    }

                    populateStaffDropdown(allRecords, headers);
                    staffSelectionSection.style.display = 'block';
                    messageBox.textContent = 'تم تحميل البيانات بنجاح. الرجاء اختيار عضو هيئة التدريس.';

                } catch (error) {
                    console.error('Error processing XLSX file:', error);
                    messageBox.textContent = `حدث خطأ أثناء معالجة الملف: ${error.message}`;
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }

            function readFileAsArrayBuffer(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (event) => resolve(event.target.result);
                    reader.onerror = (event) => reject(new Error('خطأ في قراءة الملف: ' + event.target.error.message));
                    reader.readAsArrayBuffer(file);
                });
            }

            function populateStaffDropdown(records, currentHeaders) {
                const nameHeaderIndex = currentHeaders.findIndex(h => String(h).trim() === 'الأسم');

                if (nameHeaderIndex === -1) {
                    messageBox.textContent = 'خطأ: عمود "الأسم" غير موجود في الملف.';
                    return;
                }

                const uniqueNames = new Set();
                records.forEach(record => {
                    if (record && record[nameHeaderIndex] !== undefined && String(record[nameHeaderIndex]).trim() !== '') {
                        uniqueNames.add(String(record[nameHeaderIndex]).trim());
                    }
                });

                staffSelect.innerHTML = '<option value="">-- الرجاء الاختيار --</option>';
                uniqueNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    staffSelect.appendChild(option);
                });
            }

            function displaySelectedStaffReport() {
                const selectedName = staffSelect.value;
                reportDisplayArea.innerHTML = '';

                if (!selectedName) {
                    reportDisplayArea.innerHTML = '<p class="text-gray-600">اختر عضواً من القائمة المنسدلة لعرض تقريره.</p>';
                    return;
                }

                const nameHeaderIndex = headers.findIndex(h => String(h).trim() === 'الأسم');
                const selectedRecord = allRecords.find(record => record && record[nameHeaderIndex] && String(record[nameHeaderIndex]).trim() === selectedName);

                if (selectedRecord) {
                    reportDisplayArea.innerHTML = getReportHtml(selectedRecord, headers);
                } else {
                    reportDisplayArea.innerHTML = `<p class="text-red-500">لم يتم العثور على بيانات لـ "${selectedName}".</p>`;
                }
            }

            // Function to convert numbers to Arabic text (for integers up to 9999)
            function numberToArabicText(num) {
                if (num === 0) return "صفر";
                if (typeof num !== 'number' || !Number.isInteger(num) || num < 0) return num;

                const units = ["", "واحد", "اثنين", "ثلاثة", "أربعة", "خمسة", "ستة", "سبعة", "ثمانية", "تسعة"];
                const teens = ["", "أحد عشر", "اثنا عشر", "ثلاثة عشر", "أربعة عشر", "خمسة عشر", "ستة عشر", "سبعة عشر", "ثمانية عشر", "تسعة عشر"];
                const tens = ["", "عشرة", "عشرون", "ثلاثون", "أربعون", "خمسون", "ستون", "سبعون", "ثمانون", "تسعون"];
                const hundreds = ["", "مائة", "مئتان", "ثلاثمائة", "أربعمائة", "خمسمائة", "ستمائة", "سبعمائة", "ثمانمائة", "تسعمائة"];
                const thousands = ["", "ألف", "ألفان", "ثلاثة آلاف", "أربعة آلاف", "خمسة آلاف", "ستة آلاف", "سبعة آلاف", "ثمانية آلاف", "تسعة آلاف"];
                const thousandsPlural = ["آلاف", "ألف"]; 

                let result = "";

                if (num >= 1000) {
                    const th = Math.floor(num / 1000);
                    num %= 1000;

                    if (th === 1) {
                        result += thousands[1];
                    } else if (th === 2) {
                        result += thousands[2];
                    } else if (th >= 3 && th <= 9) {
                        result += units[th] + " " + thousandsPlural[0];
                    } else { // For 10 and above thousands (e.g., 10 ألف, 20 ألف)
                        result += numberToArabicText(th) + " " + thousandsPlural[1];
                    }
                    if (num > 0) result += " و ";
                }

                if (num >= 100) {
                    const h = Math.floor(num / 100);
                    num %= 100;
                    result += hundreds[h];
                    if (num > 0) result += " و ";
                }

                if (num >= 11 && num <= 19) { // Handle teens first: 11-19
                    result += teens[num - 10];
                } else { // Then units and tens
                    const u = num % 10;
                    const t = Math.floor(num / 10);

                    if (u > 0) {
                        result += units[u];
                    }
                    if (t > 0) {
                        if (u > 0) result += " و ";
                        result += tens[t];
                    }
                }

                // Special handling for 10 if it's the only part left
                if (result === "" && num === 10) return tens[1];
                // If result is still empty and num is between 1 and 9
                if (result === "" && num > 0 && num < 10) return units[num];


                return result.trim();
            }

            // New function to get Arabic month name
            function getArabicMonthName(monthNumber) {
                const arabicMonths = [
                    "يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو",
                    "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"
                ];
                // MonthNumber is 1-indexed (1 for January)
                return arabicMonths[monthNumber - 1] || "";
            }

            // New function to normalize Arabic day names for consistent lookup and display
            function normalizeArabicDayNameForComparison(dayName) {
                if (!dayName) return '';
                let normalized = String(dayName).trim();

                const mappedDay = dayMap[normalized]; // dayMap is defined at a higher scope
                if (mappedDay) {
                    return mappedDay;
                }
                
                return normalized; 
            }

            // This function now returns the HTML string for a single report
            function getReportHtml(recordData, currentHeaders) {
                // Helper to get data by header name (case-insensitive and trimmed)
                const getField = (headerName) => {
                    const headerIndex = currentHeaders.findIndex(h => String(h).trim() === headerName.trim());
                    return headerIndex !== -1 ? (recordData[headerIndex] !== undefined ? recordData[headerIndex] : '') : '';
                };

                const name = getField('الأسم');
                const degree = getField('الدرجة العلميه');
                const department = getField('القسم');
                const employer = getField('جهة العمل');

                // --- Step 1: Populate weeklyScheduledHoursMap from Excel columns F:T ---
                const weeklyScheduledHoursMap = new Map(); // This will hold the consolidated hours per normalized day name

                const weeklyScheduleColumnIndexGroups = [
                    { dayIdx: 5, theoreticalIdx: 6, practicalIdx: 7, defaultDayImplied: 'السبت', debugName: 'Day 1 (F:H)' },   
                    { dayIdx: 8, theoreticalIdx: 9, practicalIdx: 10, defaultDayImplied: 'الأحد', debugName: 'Day 2 (I:K)' },  
                    { dayIdx: 11, theoreticalIdx: 12, practicalIdx: 13, defaultDayImplied: 'الاثنين', debugName: 'Day 3 (L:N)' }, 
                    { dayIdx: 14, theoreticalIdx: 15, practicalIdx: 16, defaultDayImplied: 'الثلاثاء', debugName: 'Day 4 (O:Q)' }, 
                    { dayIdx: 17, theoreticalIdx: 18, practicalIdx: 19, defaultDayImplied: 'الأربعاء', debugName: 'Day 5 (R:T)' }  
                ];

                weeklyScheduleColumnIndexGroups.forEach(group => {
                    const dayNameRaw = recordData[group.dayIdx];
                    const theoreticalHoursRaw = recordData[group.theoreticalIdx];
                    const practicalHoursRaw = recordData[group.practicalIdx];

                    let currentDayName = String(dayNameRaw || '').trim();
                    const theoreticalHours = parseFloat(theoreticalHoursRaw) || 0; 
                    const practicalHours = parseFloat(practicalHoursRaw) || 0;      

                    if (currentDayName === '' && (theoreticalHours > 0 || practicalHours > 0)) {
                        currentDayName = group.defaultDayImplied;
                    }

                    if (currentDayName !== '') {
                        const normalizedDayName = normalizeArabicDayNameForComparison(currentDayName);

                        if (theoreticalHours > 0 || practicalHours > 0) { 
                            if (weeklyScheduledHoursMap.has(normalizedDayName)) {
                                const existing = weeklyScheduledHoursMap.get(normalizedDayName);
                                existing.theoretical += theoreticalHours;
                                existing.practical += practicalHours;
                                weeklyScheduledHoursMap.set(normalizedDayName, existing);
                            } else {
                                weeklyScheduledHoursMap.set(normalizedDayName, { theoretical: theoreticalHours, practical: practicalHours });
                            }
                        }
                    }
                });

                // --- Step 2: Prepare data for the first table (Weekly Hours Distribution) ---
                const weeklyScheduledDaysForDisplay = [];
                let totalScheduledTheoreticalHours = 0;
                let totalScheduledPracticalHours = 0;

                orderedArabicDays.forEach(day => {
                    const normalizedDay = normalizeArabicDayNameForComparison(day);
                    if (weeklyScheduledHoursMap.has(normalizedDay)) {
                        const hours = weeklyScheduledHoursMap.get(normalizedDay);
                        weeklyScheduledDaysForDisplay.push({
                            day: normalizedDay,
                            theoretical: hours.theoretical,
                            practical: hours.practical
                        });
                        totalScheduledTheoreticalHours += hours.theoretical;
                        totalScheduledPracticalHours += hours.practical;
                    }
                });

                const remainingKeys = Array.from(weeklyScheduledHoursMap.keys()).filter(key => !orderedArabicDays.includes(key));
                remainingKeys.sort().forEach(dayName => {
                    const hours = weeklyScheduledHoursMap.get(dayName);
                    weeklyScheduledDaysForDisplay.push({
                        day: dayName,
                        theoretical: hours.theoretical,
                        practical: hours.practical
                    });
                    totalScheduledTheoreticalHours += hours.theoretical;
                    totalScheduledPracticalHours += hours.practical;
                });
                
                const totalScheduledWeeklyHours = totalScheduledTheoreticalHours + totalScheduledPracticalHours;


                // --- Step 3: Process Attendance Records for the Second Table ---
                const attendanceDates = [];
                let totalTheoreticalHoursAttendance = 0;
                let totalPracticalHoursAttendance = 0;
                let attendanceMonthHeader = "استمارات شهر أبريل - مايو 2024-2025م"; // Default value

                for (let i = 1; i <= 30; i++) { // Max days in month
                    let dateValue = getField(`يوم${i}`);

                    let theoreticalHoursToday = 0;
                    let practicalHoursToday = 0;
                    let formattedDate = '';
                    let dayOfWeekFromDate = '';

                    if (dateValue) {
                        let dateObj;
                        if (typeof dateValue === 'number') {
                            const parsedExcelDate = XLSX.SSF.parse_date_code(dateValue);
                            if (parsedExcelDate) {
                                dateObj = new Date(parsedExcelDate.y, parsedExcelDate.m - 1, parsedExcelDate.d);
                            }
                        } else {
                            dateObj = new Date(String(dateValue).replace(/(\d{4})\/(\d{2})\/(\d{2})/, '$1-$2-$3'));
                        }

                        if (dateObj instanceof Date && !isNaN(dateObj.getTime())) {
                            formattedDate = dateObj.toLocaleDateString('ar-EG', { year: 'numeric', month: '2-digit', day: '2-digit' });
                            let rawDayOfWeek = dateObj.toLocaleDateString('ar-EG', { weekday: 'long' });
                            dayOfWeekFromDate = normalizeArabicDayNameForComparison(rawDayOfWeek);
                            
                            if (i === 1) { 
                                const monthNumber = dateObj.getMonth() + 1;
                                const arabicMonth = getArabicMonthName(monthNumber);
                                const year = dateObj.getFullYear();
                                attendanceMonthHeader = `استمارة شهر ${arabicMonth} ${year}-${year + 1}م`;
                            }

                            const scheduled = weeklyScheduledHoursMap.get(dayOfWeekFromDate);

                            if (scheduled) {
                                theoreticalHoursToday = scheduled.theoretical;
                                practicalHoursToday = scheduled.practical;
                            }
                        } else {
                            formattedDate = String(dateValue);
                            dayOfWeekFromDate = 'تاريخ غير صالح';
                        }
                    }

                    if (formattedDate) {
                        attendanceDates.push({
                            serial: i,
                            date: formattedDate,
                            day: dayOfWeekFromDate,
                            theoretical: theoreticalHoursToday,
                            practical: practicalHoursToday
                        });
                        totalTheoreticalHoursAttendance += theoreticalHoursToday;
                        totalPracticalHoursAttendance += practicalHoursToday;
                    }
                }

                // Helper function for displaying values or a dash if empty/zero
                const displayValueOrDash = (value) => {
                    return (value === 0 || value === '' || value === undefined || value === null) ? '-' : value;
                };

                // Return the full HTML string for one report
                return `
                    <div class="report-content-to-print"> <!-- This div helps html2pdf target the specific content -->
                        <!-- Header Section -->
                        <div class="text-center-aligned mb-4 flex justify-center items-center relative print-header-with-logos">
                            <img src="https://placehold.co/160x160/ffffff/000000?text=Logo+1" alt="Logo 01" class="logo-left">
                            <h1 class="text-2xl font-bold text-gray-800 mb-2 mx-4">وزارة التعليم العالي</h1>
                            <img src="https://placehold.co/160x160/ffffff/000000?text=Logo+2" alt="Logo 02" class="logo-right">
                        </div>
                        <div class="text-center-aligned mb-4">
                            <h2 class="text-xl font-semibold text-gray-700 mb-1">المعهد العالي للهندسة والتكنولوجيا</h2>
                            <h3 class="text-lg text-gray-600">بكفر الشيخ</h3>
                        </div>

                        <!-- DYNAMICALLY GENERATED Attendance Month Header -->
                        <div class="mb-4">
                            <h4 class="text-xl font-bold text-gray-800 mb-4 text-center-aligned">${attendanceMonthHeader}</h4>
                        </div>

                        <!-- Faculty Member Data Section -->
                        <div class="mb-4">
                            <h4 class="text-xl font-bold text-gray-800 mb-4 text-center-aligned">بيانات عضو هيئة التدريس / الهيئة المعاونة</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                                <div class="flex justify-between border-b pb-2">
                                    <span class="font-medium">الاسم:</span>
                                    <span class="flex-grow text-right">${displayValueOrDash(name)}</span>
                                </div>
                                <div class="flex justify-between border-b pb-2">
                                    <span class="font-medium">الدرجة:</span>
                                    <span class="flex-grow text-right">${displayValueOrDash(degree)}</span>
                                </div>
                                <div class="flex justify-between border-b pb-2">
                                    <span class="font-medium">القسم:</span>
                                    <span class="flex-grow text-right">${displayValueOrDash(department)}</span>
                                </div>
                                <div class="flex justify-between border-b pb-2">
                                    <span class="font-medium">جهة الانتداب:</span>
                                    <span class="flex-grow text-right">${displayValueOrDash(employer)}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Weekly Hours Distribution Section -->
                        <div class="mb-4">
                            <h4 class="text-xl font-bold text-gray-800 mb-4 text-center-aligned">توزيع الساعات اسبوعيا</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th rowspan="2" class="w-1/3">ايام الحضور</th>
                                        <th colspan="2" class="w-2/3">ساعات التدريس</th>
                                    </tr>
                                    <tr>
                                        <th>نظري</th>
                                        <th>درس / اشراف</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${weeklyScheduledDaysForDisplay.map(schedule => `
                                        <tr>
                                            <td class="text-right-aligned">${displayValueOrDash(schedule.day)}</td>
                                            <td>${displayValueOrDash(schedule.theoretical)}</td>
                                            <td>${displayValueOrDash(schedule.practical)}</td>
                                        </tr>
                                    `).join('')}
                                    <tr>
                                        <td class="text-right-aligned font-bold">إجمالي الساعات الأسبوعية</td>
                                        <td class="font-bold">${displayValueOrDash(totalScheduledTheoreticalHours)}</td>
                                        <td class="font-bold">${displayValueOrDash(totalScheduledPracticalHours)}</td>
                                    </tr>
                                    <tr>
                                        <td colspan="3" class="text-right-aligned font-bold">إجمالي ساعات الجدول: ${displayValueOrDash(totalScheduledWeeklyHours)} ساعة</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Monthly Attendance Section -->
                        <div class="mb-4">
                            <h4 class="text-xl font-bold text-gray-800 mb-4 text-center-aligned">عدد أيام الغياب والحضور الفعلي شهريا</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>م</th>
                                        <th>تاريخ الحضور</th>
                                        <th>اليوم</th>
                                        <th>نظري</th>
                                        <th>عملي</th>
                                        <th>توقيع</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${attendanceDates.map(att => `
                                        <tr>
                                            <td>${displayValueOrDash(att.serial)}</td>
                                            <td>${displayValueOrDash(att.date)}</td>
                                            <td>${displayValueOrDash(att.day)}</td>
                                            <td>${displayValueOrDash(att.theoretical)}</td>
                                            <td>${displayValueOrDash(att.practical)}</td>
                                            <td></td> <!-- Signature column, left empty for manual signature -->
                                        </tr>
                                    `).join('')}
                                    <tr>
                                        <td colspan="3" class="text-right-aligned font-bold">إجمالي الساعات الفعلية</td>
                                        <td class="font-bold">${displayValueOrDash(totalTheoreticalHoursAttendance)}</td>
                                        <td class="font-bold">${displayValueOrDash(totalPracticalHoursAttendance)}</td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Summary -->
                        <div class="text-right-aligned mb-8">
                            <p class="mb-2" style="color: #000000;"><strong>إجمالي ساعات الدرس/الاشراف الفعلية:</strong> ${displayValueOrDash(totalPracticalHoursAttendance)} (${numberToArabicText(totalPracticalHoursAttendance)}) ساعة</p>
                            <p class="mb-2" style="color: #000000;"><strong>إجمالي ساعات المحاضرات الفعلية:</strong> ${displayValueOrDash(totalTheoreticalHoursAttendance)} (${numberToArabicText(totalTheoreticalHoursAttendance)}) ساعة</p>
                        </div>

                        <!-- New Signatures Section -->
                        <div class="signature-section-new">
                            <div class="signature-block">
                                <p class="signature-title" style="color: #000000;">التوقيع</p>
                                <div class="signature-line"></div>
                                <p class="signature-name-placeholder" style="color: #000000;"></p>
                            </div>
                            <div class="signature-block">
                                <p class="signature-title" style="color: #000000;">شئون هيئة التدريس</p>
                                <div class="signature-line"></div>
                                <p class="signature-name-placeholder" style="color: #000000;"></p>
                            </div>
                            <div class="signature-block">
                                <p class="signature-title" style="color: #000000;">أمين المعهد</p>
                                <div class="signature-line"></div>
                                <p class="signature-name-placeholder" style="color: #000000;"></p>
                            </div>
                        </div>
                        <!-- Dean's Signature Block (Moved and styled for larger, left-aligned) -->
                        <div class="signature-block dean-signature">
                            <p class="signature-title" style="color: #000000;">عميد المعهد</p>
                            <div class="signature-line"></div>
                            <p class="signature-name-actual" style="color: #000000;">( أ.د. / مصطفى كامل )</p>
                        </div>
                    </div>
                `;
            }

            async function printCurrentReport() {
                const reportContent = document.querySelector('#reportDisplayArea .report-content-to-print');
                if (!reportContent) {
                    messageBox.textContent = 'لا يوجد تقرير لعرضه.';
                    return;
                }

                loadingOverlay.style.display = 'flex';
                try {
                    // Create a temporary div to hold the content for PDF generation
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = reportContent.outerHTML; // Clone the report content

                    // Set specific options for html2pdf
                    const pdfOptions = {
                        margin: 5, /* Reduced margin for more content space */
                        filename: `تقرير_ساعات_التدريس_${staffSelect.value}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { 
                            scale: 2, 
                            dpi: 192, 
                            letterRendering: true,
                        },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                        pagebreak: {
                            mode: 'avoid-all' // This tells html2pdf to try and fit content on one page
                        }
                    };

                    await html2pdf().from(tempDiv).set(pdfOptions).save();
                    messageBox.textContent = 'تم إنشاء ملف PDF بنجاح للتقرير الحالي.';
                } catch (error) {
                    console.error('Error generating PDF for current report:', error);
                    messageBox.textContent = `حدث خطأ أثناء إنشاء PDF للتقرير الحالي: ${error.message}`;
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }

            async function generateAllReportsAndPrint() {
                if (allRecords.length === 0) {
                    messageBox.textContent = 'الرجاء تحميل ملف XLSX أولاً.';
                    return;
                }

                loadingOverlay.style.display = 'flex';
                messageBox.textContent = 'جاري إنشاء جميع تقارير PDF... قد يستغرق هذا بعض الوقت.';

                try {
                    const uniqueNames = new Set(allRecords.map(record => {
                        const nameHeaderIndex = headers.findIndex(h => String(h).trim() === 'الأسم');
                        return record && record[nameHeaderIndex] ? String(record[nameHeaderIndex]).trim() : '';
                    }).filter(name => name !== ''));

                    const allReportsHtmlContent = [];
                    for (const name of uniqueNames) {
                        const nameHeaderIndex = headers.findIndex(h => String(h).trim() === 'الأسم');
                        const record = allRecords.find(r => r && r[nameHeaderIndex] && String(r[nameHeaderIndex]).trim() === name);
                        if (record) {
                            allReportsHtmlContent.push(getReportHtml(record, headers));
                        }
                    }

                    const combinedHtml = `
                        <div class="combined-reports-container">
                            ${allReportsHtmlContent.join('<div class="page-break-after-custom"></div>')}
                        </div>
                    `;

                    // Create a temporary div to render the combined HTML for html2pdf
                    const tempDivForCombined = document.createElement('div');
                    tempDivForCombined.innerHTML = combinedHtml;
                    document.body.appendChild(tempDivForCombined); // Append to body for rendering styles correctly

                    await html2pdf().from(tempDivForCombined).set({
                        margin: 10,
                        filename: `جميع_تقارير_ساعات_التدريس.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, dpi: 192, letterRendering: true },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                        pagebreak: { mode: ['avoid-all', 'css'] } // Use 'css' to respect page-break-after
                    }).save();

                    document.body.removeChild(tempDivForCombined); // Clean up
                    messageBox.textContent = 'تم إنشاء ملف PDF مجمع لجميع التقارير بنجاح.';

                } catch (error) {
                    console.error('Error generating all PDFs:', error);
                    messageBox.textContent = `حدث خطأ أثناء إنشاء جميع ملفات PDF: ${error.message}`;
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }
        });
    </script>
</body>
</html>
